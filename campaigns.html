<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaigns | Green Sprint</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    
    <!-- Bootstrap -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/dashboard.css">
    
    <style>
        .campaigns-hero {
            background: linear-gradient(135deg, #2d5a27 0%, #4a9c3f 100%);
            color: white;
            padding: 60px 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .campaigns-hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .campaigns-hero p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto 20px;
        }
        
        .campaign-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            align-items: center;
        }
        
        .campaign-filters .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .filter-btn:hover, .filter-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }
        
        .campaigns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .campaign-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        
        .campaign-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        }
        
        .campaign-image {
            height: 200px;
            background: linear-gradient(135deg, #2d5a27 0%, #4a9c3f 100%);
            position: relative;
            overflow: hidden;
        }
        
        .campaign-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .campaign-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .campaign-badge.active {
            background: #4CAF50;
            color: white;
        }
        
        .campaign-badge.completed {
            background: #2196F3;
            color: white;
        }
        
        .campaign-badge.planning {
            background: #FF9800;
            color: white;
        }
        
        .campaign-content {
            padding: 25px;
        }
        
        .campaign-content h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .campaign-content p {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .campaign-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .campaign-stat {
            text-align: center;
        }
        
        .campaign-stat .value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .campaign-stat .label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
        }
        
        .campaign-progress {
            margin-bottom: 20px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .progress-bar-bg {
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .campaign-creator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .campaign-creator img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .campaign-creator-info h5 {
            font-size: 0.9rem;
            margin: 0;
            color: #333;
        }
        
        .campaign-creator-info span {
            font-size: 0.8rem;
            color: #888;
        }
        
        .campaign-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Create Campaign Modal */
        .create-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .create-modal-overlay.active {
            display: flex;
        }
        
        .create-modal {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .create-modal h2 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #333;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .campaigns-hero {
                padding: 40px 20px;
            }
            
            .campaigns-hero h1 {
                font-size: 1.8rem;
            }
            
            .campaigns-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="fa fa-bars"></i>
    </button>
    
    <div class="dashboard-container">
        <!-- Sidebar (same as dashboard) -->
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img src="assets/images/green spirt (1).png" alt="Green Sprint">
                <h2>Green Sprint</h2>
            </div>
            
            <ul class="sidebar-nav">
                <li><a href="dashboard.html"><i class="fa fa-home"></i><span>Dashboard</span></a></li>
                <li><a href="tree-tracker.html"><i class="fa fa-qrcode"></i><span>Plant Tree</span></a></li>
                <li><a href="my-trees.html"><i class="fa fa-tree"></i><span>My Trees</span></a></li>
                <li><a href="campaigns.html" class="active"><i class="fa fa-bullhorn"></i><span>Campaigns</span></a></li>
                <li><a href="leaderboard.html"><i class="fa fa-trophy"></i><span>Leaderboard</span></a></li>
                <li><a href="analytics.html"><i class="fa fa-chart-line"></i><span>Analytics</span></a></li>
                <li><a href="community.html"><i class="fa fa-users"></i><span>Community</span></a></li>
                <li><a href="profile.html"><i class="fa fa-user"></i><span>Profile</span></a></li>
                <li><a href="#" onclick="logout()"><i class="fa fa-sign-out-alt"></i><span>Logout</span></a></li>
            </ul>
            
            <div class="sidebar-user">
                <img src="assets/images/default-avatar.png" alt="User" id="sidebar-avatar">
                <div class="sidebar-user-info">
                    <h4 id="sidebar-username">User</h4>
                    <span>Member</span>
                </div>
            </div>
        </aside>
        
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Hero Section -->
            <div class="campaigns-hero">
                <h1>üåç Tree Planting Campaigns</h1>
                <p>Join community efforts to make a collective environmental impact. Create or participate in campaigns to plant more trees!</p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openCreateModal()" style="background: white; color: var(--primary-color);">
                        <i class="fa fa-plus"></i> Create Campaign
                    </button>
                    <button class="btn btn-primary" onclick="discoverNearbyCampaigns()" style="background: rgba(255,255,255,0.2); border: 2px solid white;">
                        <i class="fa fa-map-marker-alt"></i> Discover Nearby
                    </button>
                </div>
            </div>
            
            <!-- Discover Nearby Section (hidden by default) -->
            <div id="discover-section" style="display: none; margin-bottom: 30px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; color: white; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h3 style="margin: 0 0 5px;"><i class="fa fa-compass"></i> Discover Campaigns Near You</h3>
                            <p style="margin: 0; opacity: 0.9;" id="location-status">Searching within 200km of your location...</p>
                        </div>
                        <button onclick="closeDiscoverSection()" style="background: rgba(255,255,255,0.2); border: none; padding: 10px 20px; border-radius: 20px; color: white; cursor: pointer;">
                            <i class="fa fa-times"></i> Close
                        </button>
                    </div>
                </div>
                
                <!-- Nearby Campaigns from Database -->
                <div id="nearby-campaigns-grid" class="campaigns-grid" style="margin-bottom: 30px;">
                    <!-- Will be populated dynamically -->
                </div>
                
                <!-- External Platforms -->
                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
                    <h4 style="margin: 0 0 20px;"><i class="fa fa-external-link-alt"></i> Find More Campaigns on External Platforms</h4>
                    <div id="external-platforms" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                        <!-- Will be populated with location-based links -->
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="campaign-filters">
                <div class="search-box">
                    <input type="text" class="form-control" id="campaign-search" placeholder="Search campaigns...">
                </div>
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="active">Active</button>
                <button class="filter-btn" data-filter="completed">Completed</button>
                <button class="filter-btn" data-filter="my-campaigns">My Campaigns</button>
            </div>
            
            <!-- Campaigns Grid -->
            <div class="campaigns-grid" id="campaigns-grid">
                <!-- Loading state -->
                <div class="loading-placeholder" style="grid-column: 1/-1; text-align: center; padding: 50px;">
                    <i class="fa fa-spinner fa-spin fa-3x" style="color: var(--primary-color);"></i>
                    <p style="margin-top: 20px;">Loading campaigns...</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Create Campaign Modal -->
    <div class="create-modal-overlay" id="create-modal">
        <div class="create-modal">
            <h2><i class="fa fa-plus-circle" style="color: var(--primary-color);"></i> Create New Campaign</h2>
            
            <form id="create-campaign-form">
                <div class="form-group">
                    <label class="form-label">Campaign Name *</label>
                    <input type="text" class="form-control" name="campaign_name" required 
                           placeholder="e.g., Campus Green Initiative 2024">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <textarea class="form-control" name="description" rows="4" required
                              placeholder="Describe your campaign goals and how participants can contribute..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Target Trees *</label>
                        <input type="number" class="form-control" name="target_trees" required 
                               min="1" placeholder="100">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Campaign Type</label>
                        <select class="form-control" name="campaign_type">
                            <option value="community">Community</option>
                            <option value="school">School/University</option>
                            <option value="corporate">Corporate</option>
                            <option value="ngo">NGO</option>
                            <option value="government">Government</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Date *</label>
                        <input type="date" class="form-control" name="start_date" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">End Date *</label>
                        <input type="date" class="form-control" name="end_date" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" name="location" id="campaign-location"
                               placeholder="e.g., Mumbai, Maharashtra" style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="useCurrentLocation()" title="Use my location">
                            <i class="fa fa-crosshairs"></i>
                        </button>
                    </div>
                    <input type="hidden" name="latitude" id="campaign-lat">
                    <input type="hidden" name="longitude" id="campaign-lng">
                    <small id="location-hint" style="color: #888; font-size: 12px;"></small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Campaign Image</label>
                    <input type="file" class="form-control" name="image" accept="image/*">
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fa fa-rocket"></i> Launch Campaign
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/supabase-client.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/dashboard.js"></script>
    
    <script>
        let allCampaigns = [];
        let currentFilter = 'all';
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        async function logout() {
            await AuthService.logout();
        }
        
        function openCreateModal() {
            document.getElementById('create-modal').classList.add('active');
            // Set minimum dates
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="start_date"]').min = today;
            document.querySelector('input[name="end_date"]').min = today;
        }
        
        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('active');
        }
        
        function renderCampaigns(campaigns) {
            const grid = document.getElementById('campaigns-grid');
            
            if (campaigns.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                        <i class="fa fa-folder-open fa-3x" style="color: #ccc; margin-bottom: 20px;"></i>
                        <h3 style="color: #666;">No campaigns found</h3>
                        <p style="color: #888;">Be the first to create a campaign!</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = campaigns.map(c => {
                const progress = Math.min(100, Math.round((c.trees_planted / c.target_trees) * 100));
                const daysLeft = Math.ceil((new Date(c.end_date) - new Date()) / (1000 * 60 * 60 * 24));
                // Handle both 'name' and 'campaign_name' field names
                const campaignName = c.name || c.campaign_name || 'Untitled Campaign';
                
                return `
                    <div class="campaign-card">
                        <div class="campaign-image">
                            ${c.image_url ? `<img src="${c.image_url}" alt="${campaignName}">` : ''}
                            <span class="campaign-badge ${c.status}">${c.status}</span>
                        </div>
                        <div class="campaign-content">
                            <h3>${campaignName}</h3>
                            <p>${(c.description || '').substring(0, 120)}${c.description?.length > 120 ? '...' : ''}</p>
                            
                            <div class="campaign-stats">
                                <div class="campaign-stat">
                                    <div class="value">${c.trees_planted || 0}</div>
                                    <div class="label">Trees</div>
                                </div>
                                <div class="campaign-stat">
                                    <div class="value">${c.participant_count || 0}</div>
                                    <div class="label">Volunteers</div>
                                </div>
                                <div class="campaign-stat">
                                    <div class="value">${daysLeft > 0 ? daysLeft : 0}</div>
                                    <div class="label">Days Left</div>
                                </div>
                            </div>
                            
                            <div class="campaign-progress">
                                <div class="progress-header">
                                    <span>${c.trees_planted || 0}/${c.target_trees || 100} trees</span>
                                    <span>${progress || 0}%</span>
                                </div>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill" style="width: ${progress || 0}%"></div>
                                </div>
                            </div>
                            
                            <div class="campaign-creator">
                                <img src="${c.creator?.avatar_url || 'assets/images/default-avatar.png'}" alt="${c.creator?.full_name || 'Creator'}">
                                <div class="campaign-creator-info">
                                    <h5>${c.creator?.full_name || 'Anonymous'}</h5>
                                    <span>Campaign Creator</span>
                                </div>
                            </div>
                            
                            <div class="campaign-actions">
                                <a href="campaign-details.html?id=${c.id}" class="btn btn-secondary" style="flex: 1;">
                                    View Details
                                </a>
                                ${c.status === 'active' ? `
                                    <a href="tree-tracker.html?campaign=${c.id}" class="btn btn-primary" style="flex: 1;">
                                        <i class="fa fa-tree"></i> Plant
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterCampaigns(filter) {
            currentFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.filter-btn[data-filter="${filter}"]`).classList.add('active');
            
            // Filter campaigns
            let filtered = allCampaigns;
            const userId = AuthService.getUser()?.id;
            
            switch (filter) {
                case 'active':
                    filtered = allCampaigns.filter(c => c.status === 'active');
                    break;
                case 'completed':
                    filtered = allCampaigns.filter(c => c.status === 'completed');
                    break;
                case 'my-campaigns':
                    filtered = allCampaigns.filter(c => c.creator_id === userId);
                    break;
            }
            
            // Apply search filter
            const searchTerm = document.getElementById('campaign-search').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(c => {
                    const name = (c.name || c.campaign_name || '').toLowerCase();
                    const desc = (c.description || '').toLowerCase();
                    return name.includes(searchTerm) || desc.includes(searchTerm);
                });
            }
            
            renderCampaigns(filtered);
        }
        
        // ============================================
        // DISCOVER NEARBY CAMPAIGNS
        // ============================================
        
        let userLocation = null;
        
        async function discoverNearbyCampaigns() {
            const discoverSection = document.getElementById('discover-section');
            const statusEl = document.getElementById('location-status');
            const nearbyCampaignsGrid = document.getElementById('nearby-campaigns-grid');
            const externalPlatforms = document.getElementById('external-platforms');
            
            discoverSection.style.display = 'block';
            nearbyCampaignsGrid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 30px;">
                    <i class="fa fa-spinner fa-spin fa-2x" style="color: var(--primary-color);"></i>
                    <p style="margin-top: 15px;">Getting your location...</p>
                </div>
            `;
            
            // Scroll to discover section
            discoverSection.scrollIntoView({ behavior: 'smooth' });
            
            try {
                // Get user's location
                const position = await new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation is not supported by your browser'));
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // Cache for 5 minutes
                    });
                });
                
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Get city name from coordinates
                const cityName = await getCityFromCoordinates(userLocation.lat, userLocation.lng);
                statusEl.innerHTML = `<i class="fa fa-map-marker-alt"></i> Found ${cityName || 'your location'}! Searching within 200km...`;
                
                // Search for nearby campaigns in database
                try {
                    const nearbyCampaigns = await GreenSprintDB.campaigns.getNearby(userLocation.lat, userLocation.lng, 200);
                    
                    if (nearbyCampaigns.length > 0) {
                        nearbyCampaignsGrid.innerHTML = `
                            <div style="grid-column: 1/-1; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0;"><i class="fa fa-tree" style="color: var(--primary-color);"></i> ${nearbyCampaigns.length} Campaign${nearbyCampaigns.length > 1 ? 's' : ''} Found Nearby</h4>
                            </div>
                        ` + nearbyCampaigns.map(c => renderNearbyCampaignCard(c)).join('');
                    } else {
                        nearbyCampaignsGrid.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 30px; background: #f9f9f9; border-radius: 12px;">
                                <i class="fa fa-search fa-2x" style="color: #ccc; margin-bottom: 15px;"></i>
                                <h4 style="color: #666; margin: 0 0 10px;">No Local Campaigns Yet</h4>
                                <p style="color: #888; margin: 0 0 15px;">Be the first to create a tree planting campaign in your area!</p>
                                <button class="btn btn-primary" onclick="openCreateModal()">
                                    <i class="fa fa-plus"></i> Create Campaign
                                </button>
                            </div>
                        `;
                    }
                } catch (dbError) {
                    console.error('Database search error:', dbError);
                    nearbyCampaignsGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 30px; background: #f9f9f9; border-radius: 12px;">
                            <p style="color: #666;">No local campaigns found in database. Check external platforms below!</p>
                        </div>
                    `;
                }
                
                // Render external platform links with location
                renderExternalPlatforms(cityName, userLocation.lat, userLocation.lng);
                
            } catch (error) {
                console.error('Location error:', error);
                statusEl.innerHTML = `<i class="fa fa-exclamation-circle"></i> Could not get your location. Showing general resources instead.`;
                nearbyCampaignsGrid.innerHTML = '';
                renderExternalPlatforms('India', 20.5937, 78.9629); // Default to India center
            }
        }
        
        function closeDiscoverSection() {
            document.getElementById('discover-section').style.display = 'none';
        }
        
        // Use current location for campaign creation
        async function useCurrentLocation() {
            const locationInput = document.getElementById('campaign-location');
            const latInput = document.getElementById('campaign-lat');
            const lngInput = document.getElementById('campaign-lng');
            const hint = document.getElementById('location-hint');
            
            hint.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Getting location...';
            
            try {
                const position = await new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation is not supported'));
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });
                
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                latInput.value = lat;
                lngInput.value = lng;
                
                // Get city name
                const cityName = await getCityFromCoordinates(lat, lng);
                locationInput.value = cityName;
                hint.innerHTML = `<i class="fa fa-check-circle" style="color: green;"></i> Location set: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                
            } catch (error) {
                console.error('Location error:', error);
                hint.innerHTML = `<i class="fa fa-exclamation-circle" style="color: red;"></i> Could not get location. Please enter manually.`;
            }
        }
        
        async function getCityFromCoordinates(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                return data.address?.city || data.address?.town || data.address?.state || data.address?.country || 'Your Area';
            } catch (error) {
                console.error('Geocoding error:', error);
                return 'Your Area';
            }
        }
        
        function renderNearbyCampaignCard(campaign) {
            const progress = Math.min(100, Math.round((campaign.trees_planted / campaign.target_trees) * 100));
            const daysLeft = Math.ceil((new Date(campaign.end_date) - new Date()) / (1000 * 60 * 60 * 24));
            const campaignName = campaign.name || campaign.campaign_name || 'Tree Planting Campaign';
            const distance = campaign.distance ? `${campaign.distance.toFixed(1)} km away` : '';
            
            return `
                <div class="campaign-card" style="border: 2px solid #667eea;">
                    <div class="campaign-image">
                        ${campaign.image_url ? `<img src="${campaign.image_url}" alt="${campaignName}">` : ''}
                        <span class="campaign-badge active" style="background: #667eea;">NEARBY</span>
                        ${distance ? `<span style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;"><i class="fa fa-map-marker-alt"></i> ${distance}</span>` : ''}
                    </div>
                    <div class="campaign-content">
                        <h3>${campaignName}</h3>
                        <p>${(campaign.description || '').substring(0, 100)}...</p>
                        
                        <div class="campaign-stats">
                            <div class="campaign-stat">
                                <div class="value">${campaign.trees_planted || 0}</div>
                                <div class="label">Trees</div>
                            </div>
                            <div class="campaign-stat">
                                <div class="value">${campaign.participant_count || 0}</div>
                                <div class="label">Volunteers</div>
                            </div>
                            <div class="campaign-stat">
                                <div class="value">${daysLeft > 0 ? daysLeft : 0}</div>
                                <div class="label">Days Left</div>
                            </div>
                        </div>
                        
                        <div class="campaign-actions">
                            <a href="campaign-details.html?id=${campaign.id}" class="btn btn-secondary" style="flex: 1;">View Details</a>
                            <a href="tree-tracker.html?campaign=${campaign.id}" class="btn btn-primary" style="flex: 1;"><i class="fa fa-tree"></i> Join</a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderExternalPlatforms(cityName, lat, lng) {
            const container = document.getElementById('external-platforms');
            const encodedCity = encodeURIComponent(cityName);
            
            const platforms = [
                {
                    name: 'Meetup',
                    icon: 'fab fa-meetup',
                    color: '#ED1C40',
                    description: 'Find local tree planting events and groups',
                    url: `https://www.meetup.com/find/?keywords=tree%20planting&location=${encodedCity}`,
                    searchTerm: 'tree planting events'
                },
                {
                    name: 'Eventbrite',
                    icon: 'fas fa-ticket-alt',
                    color: '#F05537',
                    description: 'Discover environmental events near you',
                    url: `https://www.eventbrite.com/d/india--${encodedCity}/tree-planting/`,
                    searchTerm: 'tree planting events'
                },
                {
                    name: 'One Tree Planted',
                    icon: 'fas fa-tree',
                    color: '#2D5A27',
                    description: 'Global reforestation initiatives',
                    url: 'https://onetreeplanted.org/pages/plant-trees',
                    searchTerm: 'plant trees globally'
                },
                {
                    name: 'Ecosia',
                    icon: 'fas fa-leaf',
                    color: '#4DAF4E',
                    description: 'Search engine that plants trees',
                    url: `https://www.ecosia.org/search?q=tree+planting+${encodedCity}`,
                    searchTerm: 'local campaigns'
                },
                {
                    name: 'Grow Trees',
                    icon: 'fas fa-seedling',
                    color: '#228B22',
                    description: 'India\'s tree planting organization',
                    url: 'https://www.grow-trees.com/',
                    searchTerm: 'plant trees in India'
                },
                {
                    name: 'SankalpTaru',
                    icon: 'fas fa-hands-helping',
                    color: '#3CB371',
                    description: 'Plant trees across India',
                    url: 'https://sankalptaru.org/',
                    searchTerm: 'tree plantation drives'
                },
                {
                    name: 'Facebook Groups',
                    icon: 'fab fa-facebook',
                    color: '#1877F2',
                    description: 'Join local environmental groups',
                    url: `https://www.facebook.com/search/groups/?q=tree%20planting%20${encodedCity}`,
                    searchTerm: 'local groups'
                },
                {
                    name: 'Google Maps',
                    icon: 'fas fa-map',
                    color: '#4285F4',
                    description: 'Find nurseries & parks nearby',
                    url: `https://www.google.com/maps/search/tree+nursery/@${lat},${lng},12z`,
                    searchTerm: 'nurseries nearby'
                }
            ];
            
            container.innerHTML = platforms.map(p => `
                <a href="${p.url}" target="_blank" rel="noopener" class="external-platform-card" 
                   style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f9f9f9; border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.3s;">
                    <div style="width: 50px; height: 50px; background: ${p.color}; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="${p.icon}" style="color: white; font-size: 24px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h5 style="margin: 0 0 3px; color: #333;">${p.name}</h5>
                        <p style="margin: 0; font-size: 12px; color: #666;">${p.description}</p>
                    </div>
                    <i class="fa fa-external-link-alt" style="color: #888;"></i>
                </a>
            `).join('');
            
            // Add hover effect
            container.querySelectorAll('.external-platform-card').forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-3px)';
                    card.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = 'none';
                });
            });
        }
        
        // Event listeners
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => filterCampaigns(btn.dataset.filter));
        });
        
        document.getElementById('campaign-search').addEventListener('input', () => {
            filterCampaigns(currentFilter);
        });
        
        // Create campaign form
        document.getElementById('create-campaign-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!AuthService.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Creating...';
            
            try {
                // Upload image if provided
                let imageUrl = null;
                const imageFile = formData.get('image');
                if (imageFile && imageFile.size > 0) {
                    const fileName = `campaign-${Date.now()}-${imageFile.name}`;
                    const { data, error } = await GreenSprintDB.supabase
                        .storage
                        .from('campaign-images')
                        .upload(fileName, imageFile);
                    
                    if (!error) {
                        const { data: urlData } = GreenSprintDB.supabase
                            .storage
                            .from('campaign-images')
                            .getPublicUrl(fileName);
                        imageUrl = urlData.publicUrl;
                    }
                }
                
                const campaignData = {
                    name: formData.get('campaign_name'),
                    description: formData.get('description'),
                    target_trees: parseInt(formData.get('target_trees')),
                    campaign_type: formData.get('campaign_type'),
                    start_date: formData.get('start_date'),
                    end_date: formData.get('end_date'),
                    location: formData.get('location'),
                    latitude: formData.get('latitude') ? parseFloat(formData.get('latitude')) : null,
                    longitude: formData.get('longitude') ? parseFloat(formData.get('longitude')) : null,
                    image_url: imageUrl,
                    creator_id: AuthService.getUser().id,
                    status: 'active',
                    trees_planted: 0,
                    participant_count: 1
                };
                
                const campaign = await GreenSprintDB.campaigns.create(campaignData);
                
                // Award points for creating campaign
                await GreenSprintDB.users.awardPoints(
                    AuthService.getUser().id,
                    CONFIG.POINTS.CAMPAIGN_CREATED,
                    'campaign_created',
                    campaign.id
                );
                
                closeCreateModal();
                this.reset();
                
                // Reload campaigns
                allCampaigns = await GreenSprintDB.campaigns.getAll();
                filterCampaigns(currentFilter);
                
                alert('Campaign created successfully! üéâ');
                
            } catch (error) {
                alert('Error creating campaign: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-rocket"></i> Launch Campaign';
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            GreenSprintDB.init();
            await AuthService.init();
            
            if (!AuthService.isLoggedIn()) {
                window.location.href = 'login.html?redirect=campaigns.html';
                return;
            }
            
            // Update sidebar
            const profile = AuthService.getProfile();
            if (profile) {
                document.getElementById('sidebar-username').textContent = profile.full_name || profile.username;
                document.getElementById('sidebar-avatar').src = profile.avatar_url || 'assets/images/default-avatar.png';
            }
            
            // Check for hash to open create modal
            if (window.location.hash === '#create') {
                openCreateModal();
            }
            
            // Load campaigns
            try {
                allCampaigns = await GreenSprintDB.campaigns.getAll();
                filterCampaigns('all');
            } catch (error) {
                console.error('Failed to load campaigns:', error);
                document.getElementById('campaigns-grid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: red;">
                        <i class="fa fa-exclamation-triangle fa-3x" style="margin-bottom: 20px;"></i>
                        <p>Failed to load campaigns. Please try again later.</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
