<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Trees | Green Sprint</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    
    <!-- Bootstrap -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet.js CSS (FREE Map Library) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/dashboard.css">
    
    <style>
        .trees-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .trees-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }
        
        .trees-header h1 span {
            color: var(--primary-color);
        }
        
        .trees-filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        
        .filter-select {
            padding: 10px 20px;
            border: 2px solid #eee;
            border-radius: 25px;
            background: white;
            min-width: 150px;
            cursor: pointer;
        }
        
        .filter-select:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .trees-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .tree-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        
        .tree-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        }
        
        .tree-image {
            height: 180px;
            position: relative;
            background: linear-gradient(135deg, #2d5a27 0%, #4a9c3f 100%);
        }
        
        .tree-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .tree-health-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .tree-health-badge.healthy {
            background: #4CAF50;
            color: white;
        }
        
        .tree-health-badge.needs-care {
            background: #FF9800;
            color: white;
        }
        
        .tree-health-badge.critical {
            background: #f44336;
            color: white;
        }
        
        .tree-qr-badge {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-family: monospace;
        }
        
        .tree-content {
            padding: 20px;
        }
        
        .tree-species {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .tree-scientific {
            font-size: 0.9rem;
            color: #888;
            font-style: italic;
            margin-bottom: 15px;
        }
        
        .tree-info-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .tree-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .tree-info-item i {
            color: var(--primary-color);
        }
        
        .tree-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .tree-stat {
            text-align: center;
        }
        
        .tree-stat .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .tree-stat .label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }
        
        .tree-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .tree-actions .btn {
            flex: 1;
            padding: 8px;
            font-size: 0.9rem;
        }
        
        .tree-actions .btn.btn-success {
            flex: 0;
            padding: 8px 12px;
            background: #28a745;
            border-color: #28a745;
        }
        
        .tree-actions .btn.btn-success:hover {
            background: #218838;
            border-color: #218838;
        }
        
        /* Map View */
        .view-toggle {
            display: flex;
            gap: 5px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 25px;
        }
        
        .view-toggle button {
            padding: 8px 20px;
            border: none;
            background: transparent;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .view-toggle button.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .map-container {
            display: none;
            height: 500px;
            background: #f0f0f0;
            border-radius: 15px;
            align-items: center;
            justify-content: center;
        }
        
        .map-container.active {
            display: flex;
        }
        
        .grid-container.active {
            display: grid;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #888;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .share-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .share-btn:active {
            transform: translateY(0);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #888;
            margin-bottom: 20px;
        }
        
        /* Stats Summary */
        .trees-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .summary-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }
        
        .summary-card .label {
            color: #888;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .trees-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .trees-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="fa fa-bars"></i>
    </button>
    
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img src="assets/images/green spirt (1).png" alt="Green Sprint">
                <h2>Green Sprint</h2>
            </div>
            
            <ul class="sidebar-nav">
                <li><a href="dashboard.html"><i class="fa fa-home"></i><span>Dashboard</span></a></li>
                <li><a href="tree-tracker.html"><i class="fa fa-qrcode"></i><span>Plant Tree</span></a></li>
                <li><a href="my-trees.html" class="active"><i class="fa fa-tree"></i><span>My Trees</span></a></li>
                <li><a href="campaigns.html"><i class="fa fa-bullhorn"></i><span>Campaigns</span></a></li>
                <li><a href="leaderboard.html"><i class="fa fa-trophy"></i><span>Leaderboard</span></a></li>
                <li><a href="analytics.html"><i class="fa fa-chart-line"></i><span>Analytics</span></a></li>
                <li><a href="community.html"><i class="fa fa-users"></i><span>Community</span></a></li>
                <li><a href="profile.html"><i class="fa fa-user"></i><span>Profile</span></a></li>
                <li><a href="#" onclick="logout()"><i class="fa fa-sign-out-alt"></i><span>Logout</span></a></li>
            </ul>
            
            <div class="sidebar-user">
                <img src="assets/images/default-avatar.png" alt="User" id="sidebar-avatar">
                <div class="sidebar-user-info">
                    <h4 id="sidebar-username">User</h4>
                    <span>Member</span>
                </div>
            </div>
        </aside>
        
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Header -->
            <div class="trees-header">
                <div>
                    <h1>üå≥ My <span>Trees</span></h1>
                    <p style="color: #888;">Manage and track all the trees you've planted</p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div class="view-toggle">
                        <button class="active" onclick="switchView('grid')">
                            <i class="fa fa-th"></i> Grid
                        </button>
                        <button onclick="switchView('map')">
                            <i class="fa fa-map"></i> Map
                        </button>
                    </div>
                    <a href="tree-tracker.html" class="btn btn-primary">
                        <i class="fa fa-plus"></i> Plant Tree
                    </a>
                </div>
            </div>
            
            <!-- Summary Stats -->
            <div class="trees-summary">
                <div class="summary-card">
                    <i class="fa fa-tree"></i>
                    <div class="value" id="total-trees">0</div>
                    <div class="label">Total Trees</div>
                </div>
                <div class="summary-card">
                    <i class="fa fa-heartbeat"></i>
                    <div class="value" id="healthy-trees">0</div>
                    <div class="label">Healthy Trees</div>
                </div>
                <div class="summary-card">
                    <i class="fa fa-cloud"></i>
                    <div class="value" id="total-co2">0 kg</div>
                    <div class="label">CO‚ÇÇ Absorbed/Year</div>
                </div>
                <div class="summary-card">
                    <i class="fa fa-check-circle"></i>
                    <div class="value" id="survival-rate">0%</div>
                    <div class="label">Survival Rate</div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="trees-filters">
                <input type="text" class="filter-select" id="search-trees" placeholder="üîç Search trees..." style="flex: 1; min-width: 200px;">
                <select class="filter-select" id="filter-health" onchange="applyFilters()">
                    <option value="">All Health Status</option>
                    <option value="healthy">Healthy</option>
                    <option value="needs_care">Needs Care</option>
                    <option value="critical">Critical</option>
                </select>
                <select class="filter-select" id="filter-species" onchange="applyFilters()">
                    <option value="">All Species</option>
                </select>
                <select class="filter-select" id="filter-sort" onchange="applyFilters()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="species">By Species</option>
                </select>
            </div>
            
            <!-- Grid View -->
            <div class="trees-grid grid-container active" id="trees-grid">
                <!-- Trees will be loaded here -->
                <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                    <i class="fa fa-spinner fa-spin fa-3x" style="color: var(--primary-color);"></i>
                    <p style="margin-top: 20px;">Loading your trees...</p>
                </div>
            </div>
            
            <!-- Map View -->
            <div class="map-container" id="map-container">
                <div id="trees-map" style="width: 100%; height: 500px; border-radius: 12px;"></div>
            </div>
        </main>
    </div>
    
    <!-- Share Modal -->
    <div class="modal-overlay" id="share-modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>üì£ Share Your Achievement</h3>
                <button class="modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Share Preview Card -->
                <div class="share-preview-card" id="share-preview-card" style="background: linear-gradient(135deg, #2d5a27, #4a9f4d); color: white; padding: 25px; border-radius: 16px; text-align: center; margin-bottom: 20px;">
                    <img id="share-tree-image" src="assets/images/default-tree.jpg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid white; margin-bottom: 15px;">
                    <h3 id="share-tree-name" style="margin: 0 0 5px;">My Tree</h3>
                    <p id="share-tree-species" style="margin: 0 0 15px; font-style: italic; opacity: 0.9;"></p>
                    <div style="display: flex; justify-content: center; gap: 25px; margin-top: 15px;">
                        <div>
                            <div id="share-co2" style="font-size: 1.5rem; font-weight: bold;">0</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">kg CO‚ÇÇ/year</div>
                        </div>
                        <div>
                            <div id="share-water" style="font-size: 1.5rem; font-weight: bold;">0</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">L Water/year</div>
                        </div>
                        <div>
                            <div id="share-oxygen" style="font-size: 1.5rem; font-weight: bold;">0</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">kg O‚ÇÇ/year</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; font-size: 0.9rem;">üå± Planted via Green Sprint</p>
                </div>
                
                <!-- Share Buttons -->
                <div class="share-platforms" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                    <button class="share-btn whatsapp" onclick="shareToWhatsApp()" style="background: #25D366; color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <i class="fab fa-whatsapp" style="font-size: 24px;"></i>
                        <span style="font-size: 12px;">WhatsApp</span>
                    </button>
                    <button class="share-btn instagram" onclick="shareToInstagram()" style="background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <i class="fab fa-instagram" style="font-size: 24px;"></i>
                        <span style="font-size: 12px;">Instagram</span>
                    </button>
                    <button class="share-btn twitter" onclick="shareToTwitter()" style="background: #1DA1F2; color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <i class="fab fa-twitter" style="font-size: 24px;"></i>
                        <span style="font-size: 12px;">Twitter</span>
                    </button>
                    <button class="share-btn facebook" onclick="shareToFacebook()" style="background: #1877F2; color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <i class="fab fa-facebook" style="font-size: 24px;"></i>
                        <span style="font-size: 12px;">Facebook</span>
                    </button>
                    <button class="share-btn linkedin" onclick="shareToLinkedIn()" style="background: #0A66C2; color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <i class="fab fa-linkedin" style="font-size: 24px;"></i>
                        <span style="font-size: 12px;">LinkedIn</span>
                    </button>
                    <button class="share-btn telegram" onclick="shareToTelegram()" style="background: #0088cc; color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <i class="fab fa-telegram" style="font-size: 24px;"></i>
                        <span style="font-size: 12px;">Telegram</span>
                    </button>
                </div>
                
                <!-- Copy Link -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="share-link" readonly style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <button onclick="copyShareLink()" id="copy-btn" style="background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer;">
                        <i class="fa fa-copy"></i> Copy
                    </button>
                </div>
                
                <!-- Download for Stories -->
                <button onclick="downloadShareImage()" style="width: 100%; background: linear-gradient(135deg, #833AB4, #E1306C); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fa fa-download"></i> Download Image for Stories
                </button>
            </div>
        </div>
    </div>
    
    <!-- Leaflet.js (FREE Map Library) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Scripts -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/supabase-client.js"></script>
    <script src="assets/js/auth.js"></script>
    
    <script>
        let allTrees = [];
        let currentView = 'grid';
        let treesMap = null;
        let mapMarkers = [];
        
        // Custom tree icon for map
        const treeIcon = L.divIcon({
            html: '<div style="background: #2d5a27; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üå≥</div>',
            className: 'tree-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
        });
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        async function logout() {
            await AuthService.logout();
        }
        
        function initMap() {
            if (treesMap) return;
            
            // Initialize map centered on India
            treesMap = L.map('trees-map').setView([20.5937, 78.9629], 5);
            
            // Add OpenStreetMap tiles (FREE!)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(treesMap);
        }
        
        function updateMapMarkers() {
            if (!treesMap) return;
            
            // Clear existing markers
            mapMarkers.forEach(marker => treesMap.removeLayer(marker));
            mapMarkers = [];
            
            // Add markers for each tree
            const bounds = [];
            
            allTrees.forEach(tree => {
                let lat, lng;
                
                // Try different location formats
                if (tree.latitude && tree.longitude) {
                    lat = tree.latitude;
                    lng = tree.longitude;
                } else if (tree.location?.coordinates) {
                    lng = tree.location.coordinates[0];
                    lat = tree.location.coordinates[1];
                } else if (tree.location?.latitude) {
                    lat = tree.location.latitude;
                    lng = tree.location.longitude;
                }
                
                if (lat && lng) {
                    const marker = L.marker([lat, lng], { icon: treeIcon })
                        .addTo(treesMap)
                        .bindPopup(`
                            <div style="min-width: 200px;">
                                <img src="${tree.photo_url || 'assets/images/default-tree.jpg'}" 
                                     style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #2d5a27;">${tree.species?.common_name || 'Tree'}</h4>
                                <p style="margin: 5px 0; font-size: 12px; color: #666;">
                                    <em>${tree.species?.scientific_name || ''}</em>
                                </p>
                                <p style="margin: 5px 0; font-size: 12px;">
                                    üìÖ Planted: ${formatDate(tree.planting_date)}
                                </p>
                                <p style="margin: 5px 0; font-size: 12px;">
                                    üíö Status: ${tree.health_status || 'Healthy'}
                                </p>
                                <a href="tree-details.html?id=${tree.id}" 
                                   style="display: inline-block; margin-top: 10px; padding: 5px 15px; background: #2d5a27; color: white; text-decoration: none; border-radius: 20px; font-size: 12px;">
                                    View Details ‚Üí
                                </a>
                            </div>
                        `);
                    
                    mapMarkers.push(marker);
                    bounds.push([lat, lng]);
                }
            });
            
            // Fit map to show all markers
            if (bounds.length > 0) {
                treesMap.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        function switchView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.view-toggle button[onclick="switchView('${view}')"]`).classList.add('active');
            
            if (view === 'grid') {
                document.getElementById('trees-grid').classList.add('active');
                document.getElementById('map-container').classList.remove('active');
            } else {
                document.getElementById('trees-grid').classList.remove('active');
                document.getElementById('map-container').classList.add('active');
                
                // Initialize map on first view
                setTimeout(() => {
                    initMap();
                    updateMapMarkers();
                    treesMap.invalidateSize();
                }, 100);
            }
        }
        
        function getHealthClass(status) {
            switch (status) {
                case 'healthy': return 'healthy';
                case 'needs_care': return 'needs-care';
                case 'critical': return 'critical';
                default: return 'healthy';
            }
        }
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }
        
        function calculateAge(plantingDate) {
            const planted = new Date(plantingDate);
            const now = new Date();
            const months = Math.floor((now - planted) / (1000 * 60 * 60 * 24 * 30));
            
            if (months < 1) return 'Just planted';
            if (months < 12) return `${months} month${months > 1 ? 's' : ''} old`;
            
            const years = Math.floor(months / 12);
            return `${years} year${years > 1 ? 's' : ''} old`;
        }
        
        function renderTrees(trees) {
            const grid = document.getElementById('trees-grid');
            
            if (trees.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fa fa-tree"></i>
                        <h3>No trees found</h3>
                        <p>Start your journey by planting your first tree!</p>
                        <a href="tree-tracker.html" class="btn btn-primary">
                            <i class="fa fa-plus"></i> Plant Your First Tree
                        </a>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = trees.map(tree => {
                const co2 = Math.round((tree.co2_sequestered_kg || 0) + 22);
                const water = Math.round((tree.water_saved_liters || 0) + 400);
                
                return `
                    <div class="tree-card">
                        <div class="tree-image">
                            ${tree.photo_url ? `<img src="${tree.photo_url}" alt="${tree.species?.common_name || 'Tree'}">` : ''}
                            <span class="tree-health-badge ${getHealthClass(tree.health_status)}">
                                ${tree.health_status?.replace('_', ' ') || 'Healthy'}
                            </span>
                            <span class="tree-qr-badge">
                                <i class="fa fa-qrcode"></i> ${tree.qr_code_id || 'N/A'}
                            </span>
                        </div>
                        <div class="tree-content">
                            <div class="tree-species">${tree.species?.common_name || 'Unknown Tree'}</div>
                            <div class="tree-scientific">${tree.species?.scientific_name || ''}</div>
                            
                            <div class="tree-info-row">
                                <div class="tree-info-item">
                                    <i class="fa fa-calendar"></i>
                                    ${formatDate(tree.planting_date)}
                                </div>
                                <div class="tree-info-item">
                                    <i class="fa fa-clock"></i>
                                    ${calculateAge(tree.planting_date)}
                                </div>
                            </div>
                            
                            <div class="tree-stats">
                                <div class="tree-stat">
                                    <div class="value">${co2}</div>
                                    <div class="label">CO‚ÇÇ kg/yr</div>
                                </div>
                                <div class="tree-stat">
                                    <div class="value">${water}</div>
                                    <div class="label">Water L/yr</div>
                                </div>
                                <div class="tree-stat">
                                    <div class="value">${tree.height_cm || '-'}</div>
                                    <div class="label">Height cm</div>
                                </div>
                            </div>
                            
                            <div class="tree-actions">
                                <button class="btn btn-secondary" onclick="viewTree('${tree.id}')">
                                    <i class="fa fa-eye"></i> View
                                </button>
                                <button class="btn btn-primary" onclick="updateTree('${tree.id}')">
                                    <i class="fa fa-edit"></i> Update
                                </button>
                                <button class="btn btn-success" onclick="shareTree('${tree.id}')" title="Share">
                                    <i class="fa fa-share-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateStats(trees) {
            const total = trees.length;
            const healthy = trees.filter(t => t.health_status === 'healthy').length;
            const alive = trees.filter(t => t.survival_status !== false).length;
            const co2 = trees.reduce((sum, t) => sum + (t.co2_sequestered_kg || 22), 0);
            
            document.getElementById('total-trees').textContent = total;
            document.getElementById('healthy-trees').textContent = healthy;
            document.getElementById('total-co2').textContent = Math.round(co2) + ' kg';
            document.getElementById('survival-rate').textContent = total > 0 ? Math.round((alive / total) * 100) + '%' : '0%';
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('search-trees').value.toLowerCase();
            const healthFilter = document.getElementById('filter-health').value;
            const speciesFilter = document.getElementById('filter-species').value;
            const sortBy = document.getElementById('filter-sort').value;
            
            let filtered = [...allTrees];
            
            // Apply search
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    (t.species?.common_name || '').toLowerCase().includes(searchTerm) ||
                    (t.species?.scientific_name || '').toLowerCase().includes(searchTerm) ||
                    (t.qr_code_id || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply health filter
            if (healthFilter) {
                filtered = filtered.filter(t => t.health_status === healthFilter);
            }
            
            // Apply species filter
            if (speciesFilter) {
                filtered = filtered.filter(t => t.species_id === speciesFilter);
            }
            
            // Apply sorting
            switch (sortBy) {
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.planting_date) - new Date(b.planting_date));
                    break;
                case 'species':
                    filtered.sort((a, b) => (a.species?.common_name || '').localeCompare(b.species?.common_name || ''));
                    break;
                default: // newest
                    filtered.sort((a, b) => new Date(b.planting_date) - new Date(a.planting_date));
            }
            
            renderTrees(filtered);
        }
        
        function viewTree(treeId) {
            window.location.href = `tree-details.html?id=${treeId}`;
        }
        
        function updateTree(treeId) {
            // Redirect to tree details page where update modal is available
            window.location.href = `tree-details.html?id=${treeId}&action=update`;
        }
        
        // Share Modal Variables
        let currentShareTree = null;
        let currentShareUrl = '';
        
        function shareTree(treeId) {
            const tree = allTrees.find(t => t.id === treeId);
            if (!tree) return;
            
            currentShareTree = tree;
            currentShareUrl = `${window.location.origin}/tree-details.html?id=${treeId}`;
            
            // Calculate environmental impact
            const plantingDate = new Date(tree.planting_date);
            const now = new Date();
            const yearsGrown = Math.max((now - plantingDate) / (1000 * 60 * 60 * 24 * 365.25), 0.1);
            
            const co2 = (22 * yearsGrown).toFixed(1);
            const water = Math.round(400 * yearsGrown);
            const oxygen = (118 * yearsGrown).toFixed(1);
            
            // Update modal content
            document.getElementById('share-tree-image').src = tree.photo_url || 'assets/images/default-tree.jpg';
            document.getElementById('share-tree-name').textContent = tree.species?.common_name || 'My Tree';
            document.getElementById('share-tree-species').textContent = tree.species?.scientific_name || '';
            document.getElementById('share-co2').textContent = co2;
            document.getElementById('share-water').textContent = water;
            document.getElementById('share-oxygen').textContent = oxygen;
            document.getElementById('share-link').value = currentShareUrl;
            
            // Show modal
            document.getElementById('share-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
            document.body.style.overflow = '';
            currentShareTree = null;
        }
        
        function getShareText() {
            if (!currentShareTree) return '';
            const treeName = currentShareTree.species?.common_name || 'a tree';
            const plantingDate = new Date(currentShareTree.planting_date);
            const now = new Date();
            const yearsGrown = Math.max((now - plantingDate) / (1000 * 60 * 60 * 24 * 365.25), 0.1);
            const co2 = (22 * yearsGrown).toFixed(1);
            
            return `üå≥ I planted ${treeName} through Green Sprint! This tree has absorbed ${co2}kg of CO‚ÇÇ! Join me in making our planet greener! üåçüíö`;
        }
        
        function shareToWhatsApp() {
            const text = encodeURIComponent(getShareText() + '\n\n' + currentShareUrl);
            window.open(`https://api.whatsapp.com/send?text=${text}`, '_blank');
        }
        
        function shareToInstagram() {
            // Instagram doesn't have a direct share URL, so we'll copy and prompt
            navigator.clipboard.writeText(getShareText() + '\n\n' + currentShareUrl);
            alert('üì∑ Text copied! Open Instagram, create a Story or Post, and paste the caption.\n\nTip: Download the image below to share on your Story!');
        }
        
        function shareToTwitter() {
            const text = encodeURIComponent(getShareText());
            const url = encodeURIComponent(currentShareUrl);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}&hashtags=GreenSprint,ClimateAction,TreePlanting`, '_blank');
        }
        
        function shareToFacebook() {
            const url = encodeURIComponent(currentShareUrl);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${encodeURIComponent(getShareText())}`, '_blank');
        }
        
        function shareToLinkedIn() {
            const url = encodeURIComponent(currentShareUrl);
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank');
        }
        
        function shareToTelegram() {
            const text = encodeURIComponent(getShareText());
            const url = encodeURIComponent(currentShareUrl);
            window.open(`https://t.me/share/url?url=${url}&text=${text}`, '_blank');
        }
        
        function copyShareLink() {
            const link = document.getElementById('share-link').value;
            navigator.clipboard.writeText(getShareText() + '\n\n' + link).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.innerHTML = '<i class="fa fa-check"></i> Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa fa-copy"></i> Copy';
                    btn.style.background = 'var(--primary-color)';
                }, 2000);
            });
        }
        
        async function downloadShareImage() {
            if (!currentShareTree) return;
            
            const tree = currentShareTree;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Story dimensions (9:16 ratio)
            canvas.width = 1080;
            canvas.height = 1920;
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a4d1a');
            gradient.addColorStop(0.5, '#2d5a27');
            gradient.addColorStop(1, '#1a4d1a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add decorative elements
            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
            for (let i = 0; i < 20; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 100 + 30, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Title
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 72px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('üå≥ GREEN SPRINT', canvas.width / 2, 200);
            
            // Subtitle
            ctx.font = '36px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.fillText('Environmental Stewardship', canvas.width / 2, 260);
            
            // Tree Photo Circle
            const centerX = canvas.width / 2;
            const photoY = 500;
            const photoRadius = 180;
            
            try {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = tree.photo_url || 'assets/images/default-tree.jpg';
                });
                
                // Draw circular photo
                ctx.save();
                ctx.beginPath();
                ctx.arc(centerX, photoY, photoRadius, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                
                const aspectRatio = img.width / img.height;
                let drawWidth, drawHeight;
                if (aspectRatio > 1) {
                    drawHeight = photoRadius * 2;
                    drawWidth = drawHeight * aspectRatio;
                } else {
                    drawWidth = photoRadius * 2;
                    drawHeight = drawWidth / aspectRatio;
                }
                ctx.drawImage(img, centerX - drawWidth/2, photoY - drawHeight/2, drawWidth, drawHeight);
                ctx.restore();
                
                // Photo border
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.arc(centerX, photoY, photoRadius, 0, Math.PI * 2);
                ctx.stroke();
            } catch (e) {
                // Draw placeholder circle
                ctx.fillStyle = '#4a9f4d';
                ctx.beginPath();
                ctx.arc(centerX, photoY, photoRadius, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = '120px Arial';
                ctx.fillStyle = '#ffffff';
                ctx.fillText('üå≥', centerX - 60, photoY + 40);
            }
            
            // Tree name
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 56px Arial, sans-serif';
            ctx.fillText(tree.species?.common_name || 'My Tree', centerX, 780);
            
            // Scientific name
            ctx.font = 'italic 32px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.fillText(tree.species?.scientific_name || '', centerX, 840);
            
            // Divider
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width * 0.2, 920);
            ctx.lineTo(canvas.width * 0.8, 920);
            ctx.stroke();
            
            // Calculate impact
            const plantingDate = new Date(tree.planting_date);
            const now = new Date();
            const yearsGrown = Math.max((now - plantingDate) / (1000 * 60 * 60 * 24 * 365.25), 0.1);
            
            const co2 = (22 * yearsGrown).toFixed(1);
            const water = Math.round(400 * yearsGrown);
            const oxygen = (118 * yearsGrown).toFixed(1);
            
            // Impact Stats
            const statsY = 1050;
            const statsSpacing = 280;
            
            const stats = [
                { value: co2, unit: 'kg', label: 'CO‚ÇÇ Absorbed', emoji: 'üåø' },
                { value: water, unit: 'L', label: 'Water Conserved', emoji: 'üíß' },
                { value: oxygen, unit: 'kg', label: 'Oxygen Produced', emoji: 'üå¨Ô∏è' }
            ];
            
            stats.forEach((stat, i) => {
                const x = centerX - statsSpacing + (i * statsSpacing);
                
                // Emoji
                ctx.font = '48px Arial';
                ctx.fillText(stat.emoji, x, statsY);
                
                // Value
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 52px Arial, sans-serif';
                ctx.fillText(`${stat.value}${stat.unit}`, x, statsY + 70);
                
                // Label
                ctx.font = '24px Arial, sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.fillText(stat.label, x, statsY + 110);
            });
            
            // Planting date
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '32px Arial, sans-serif';
            const plantedText = `üìÖ Planted: ${new Date(tree.planting_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
            ctx.fillText(plantedText, centerX, 1280);
            
            // CTA Box
            ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
            roundRect(ctx, canvas.width * 0.1, 1400, canvas.width * 0.8, 200, 20);
            ctx.fill();
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 40px Arial, sans-serif';
            ctx.fillText('Join the Green Movement! üåç', centerX, 1480);
            
            ctx.font = '28px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.fillText('Plant your own tree at Green Sprint', centerX, 1540);
            
            // Footer
            ctx.font = '28px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.fillText('üå± Green Sprint - Environmental Stewardship', centerX, 1800);
            
            // Download
            const link = document.createElement('a');
            link.download = `green-sprint-${tree.species?.common_name?.replace(/\s+/g, '-') || 'tree'}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        // Helper function for rounded rectangles
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }
        
        // Close modal on overlay click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'share-modal') {
                closeShareModal();
            }
        });
        
        // Search input listener
        document.getElementById('search-trees').addEventListener('input', applyFilters);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            GreenSprintDB.init();
            await AuthService.init();
            
            if (!AuthService.isLoggedIn()) {
                window.location.href = 'login.html?redirect=my-trees.html';
                return;
            }
            
            const userId = AuthService.getUser().id;
            
            // Update sidebar
            const profile = AuthService.getProfile();
            if (profile) {
                document.getElementById('sidebar-username').textContent = profile.full_name || profile.username;
                document.getElementById('sidebar-avatar').src = profile.avatar_url || 'assets/images/default-avatar.png';
            }
            
            // Load trees
            try {
                allTrees = await GreenSprintDB.trees.getByUser(userId);
                
                updateStats(allTrees);
                renderTrees(allTrees);
                
                // Populate species filter
                const speciesSet = new Set();
                allTrees.forEach(t => {
                    if (t.species_id && t.species?.common_name) {
                        speciesSet.add(JSON.stringify({ id: t.species_id, name: t.species.common_name }));
                    }
                });
                
                const speciesSelect = document.getElementById('filter-species');
                speciesSet.forEach(s => {
                    const species = JSON.parse(s);
                    speciesSelect.innerHTML += `<option value="${species.id}">${species.name}</option>`;
                });
                
            } catch (error) {
                console.error('Failed to load trees:', error);
                document.getElementById('trees-grid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: red;">
                        <i class="fa fa-exclamation-triangle fa-3x" style="margin-bottom: 20px;"></i>
                        <p>Failed to load trees. Please try again later.</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
