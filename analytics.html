<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | Green Sprint</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    
    <!-- Bootstrap -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/dashboard.css">
    
    <style>
        .analytics-header {
            margin-bottom: 30px;
        }
        
        .analytics-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }
        
        .analytics-header p {
            color: #888;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .analytics-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .analytics-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(74, 156, 63, 0.1), transparent);
            border-radius: 0 0 0 100%;
        }
        
        .analytics-card h3 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .analytics-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 10px;
        }
        
        .analytics-card .trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .analytics-card .trend.up {
            color: #4CAF50;
        }
        
        .analytics-card .trend.down {
            color: #f44336;
        }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .chart-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .impact-summary {
            background: linear-gradient(135deg, #2d5a27 0%, #4a9c3f 100%);
            border-radius: 15px;
            padding: 30px;
            color: white;
            margin-bottom: 30px;
        }
        
        .impact-summary h2 {
            font-size: 1.5rem;
            margin-bottom: 25px;
        }
        
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 25px;
        }
        
        .impact-item {
            text-align: center;
        }
        
        .impact-item i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .impact-item .value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .impact-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .leaderboard-mini {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .leaderboard-mini h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .leaderboard-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .leaderboard-row:last-child {
            border-bottom: none;
        }
        
        .leaderboard-rank {
            width: 30px;
            font-weight: 700;
            color: #888;
        }
        
        .leaderboard-rank.gold { color: #FFD700; }
        .leaderboard-rank.silver { color: #C0C0C0; }
        .leaderboard-rank.bronze { color: #CD7F32; }
        
        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .leaderboard-info {
            flex: 1;
        }
        
        .leaderboard-info h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin: 0;
        }
        
        .leaderboard-info span {
            font-size: 0.8rem;
            color: #888;
        }
        
        .leaderboard-trees {
            font-weight: 700;
            color: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .analytics-card .value {
                font-size: 2rem;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="fa fa-bars"></i>
    </button>
    
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img src="assets/images/green spirt (1).png" alt="Green Sprint">
                <h2>Green Sprint</h2>
            </div>
            
            <ul class="sidebar-nav">
                <li><a href="dashboard.html"><i class="fa fa-home"></i><span>Dashboard</span></a></li>
                <li><a href="tree-tracker.html"><i class="fa fa-qrcode"></i><span>Plant Tree</span></a></li>
                <li><a href="my-trees.html"><i class="fa fa-tree"></i><span>My Trees</span></a></li>
                <li><a href="campaigns.html"><i class="fa fa-bullhorn"></i><span>Campaigns</span></a></li>
                <li><a href="leaderboard.html"><i class="fa fa-trophy"></i><span>Leaderboard</span></a></li>
                <li><a href="analytics.html" class="active"><i class="fa fa-chart-line"></i><span>Analytics</span></a></li>
                <li><a href="community.html"><i class="fa fa-users"></i><span>Community</span></a></li>
                <li><a href="profile.html"><i class="fa fa-user"></i><span>Profile</span></a></li>
                <li><a href="#" onclick="logout()"><i class="fa fa-sign-out-alt"></i><span>Logout</span></a></li>
            </ul>
            
            <div class="sidebar-user">
                <img src="assets/images/default-avatar.png" alt="User" id="sidebar-avatar">
                <div class="sidebar-user-info">
                    <h4 id="sidebar-username">User</h4>
                    <span>Member</span>
                </div>
            </div>
        </aside>
        
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Header -->
            <div class="analytics-header">
                <h1>üìä Analytics Dashboard</h1>
                <p>Track the environmental impact of the Green Sprint community</p>
            </div>
            
            <!-- Impact Summary -->
            <div class="impact-summary">
                <h2>üåç Total Environmental Impact</h2>
                <div class="impact-grid">
                    <div class="impact-item">
                        <i class="fa fa-tree"></i>
                        <div class="value" id="global-trees">0</div>
                        <div class="label">Trees Planted</div>
                    </div>
                    <div class="impact-item">
                        <i class="fa fa-cloud"></i>
                        <div class="value" id="global-co2">0</div>
                        <div class="label">kg CO‚ÇÇ/Year</div>
                    </div>
                    <div class="impact-item">
                        <i class="fa fa-tint"></i>
                        <div class="value" id="global-water">0</div>
                        <div class="label">L Water/Year</div>
                    </div>
                    <div class="impact-item">
                        <i class="fa fa-wind"></i>
                        <div class="value" id="global-oxygen">0</div>
                        <div class="label">kg O‚ÇÇ/Year</div>
                    </div>
                    <div class="impact-item">
                        <i class="fa fa-users"></i>
                        <div class="value" id="global-users">0</div>
                        <div class="label">Eco Warriors</div>
                    </div>
                    <div class="impact-item">
                        <i class="fa fa-bullhorn"></i>
                        <div class="value" id="global-campaigns">0</div>
                        <div class="label">Campaigns</div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Cards -->
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>Trees This Month</h3>
                    <div class="value" id="monthly-trees">0</div>
                    <div class="trend up">
                        <i class="fa fa-arrow-up"></i>
                        <span id="monthly-growth">+0%</span> from last month
                    </div>
                </div>
                <div class="analytics-card">
                    <h3>Active Campaigns</h3>
                    <div class="value" id="active-campaigns">0</div>
                    <div class="trend">
                        <span>Currently running</span>
                    </div>
                </div>
                <div class="analytics-card">
                    <h3>New Users</h3>
                    <div class="value" id="new-users">0</div>
                    <div class="trend up">
                        <i class="fa fa-arrow-up"></i>
                        <span>This month</span>
                    </div>
                </div>
                <div class="analytics-card">
                    <h3>Survival Rate</h3>
                    <div class="value" id="survival-rate">95%</div>
                    <div class="trend up">
                        <i class="fa fa-leaf"></i>
                        <span>Trees thriving</span>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="chart-card">
                        <h3>Trees Planted Over Time</h3>
                        <div class="chart-container">
                            <canvas id="trees-timeline-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-card">
                        <h3>Species Distribution</h3>
                        <div class="chart-container">
                            <canvas id="species-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-card">
                        <h3>Campaign Performance</h3>
                        <div class="chart-container">
                            <canvas id="campaigns-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="leaderboard-mini">
                        <h3>üèÜ Top Planters This Month</h3>
                        <div id="top-planters">
                            <!-- Top planters will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Geographic Distribution -->
            <div class="chart-card">
                <h3>Geographic Distribution</h3>
                <div class="chart-container" style="display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #888;">
                        <i class="fa fa-map-marked-alt fa-3x" style="margin-bottom: 20px; color: var(--primary-color);"></i>
                        <p>Interactive map showing tree distribution</p>
                        <p style="font-size: 0.9rem;">Coming soon with Google Maps integration</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Scripts -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/supabase-client.js"></script>
    <script src="assets/js/auth.js"></script>
    
    <script>
        let treesTimelineChart, speciesChart, campaignsChart;
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        async function logout() {
            await AuthService.logout();
        }
        
        function initCharts() {
            // Trees Timeline Chart
            const treesCtx = document.getElementById('trees-timeline-chart').getContext('2d');
            treesTimelineChart = new Chart(treesCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Trees Planted',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#4a9c3f',
                        backgroundColor: 'rgba(74, 156, 63, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Species Distribution Chart
            const speciesCtx = document.getElementById('species-chart').getContext('2d');
            speciesChart = new Chart(speciesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Neem', 'Banyan', 'Mango', 'Peepal', 'Other'],
                    datasets: [{
                        data: [25, 20, 18, 15, 22],
                        backgroundColor: [
                            '#4CAF50',
                            '#8BC34A',
                            '#CDDC39',
                            '#FFC107',
                            '#FF9800'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Campaigns Performance Chart
            const campaignsCtx = document.getElementById('campaigns-chart').getContext('2d');
            campaignsChart = new Chart(campaignsCtx, {
                type: 'bar',
                data: {
                    labels: ['Campaign A', 'Campaign B', 'Campaign C', 'Campaign D'],
                    datasets: [{
                        label: 'Trees Planted',
                        data: [50, 75, 30, 45],
                        backgroundColor: '#4a9c3f'
                    }, {
                        label: 'Target',
                        data: [100, 100, 50, 75],
                        backgroundColor: '#ddd'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderTopPlanters(users) {
            const container = document.getElementById('top-planters');
            
            container.innerHTML = users.slice(0, 5).map((user, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '#' + (index + 1);
                
                return `
                    <div class="leaderboard-row">
                        <div class="leaderboard-rank ${rankClass}">${rankEmoji}</div>
                        <img class="leaderboard-avatar" src="${user.avatar_url || 'assets/images/default-avatar.png'}" alt="${user.full_name}">
                        <div class="leaderboard-info">
                            <h4>${user.full_name || user.username}</h4>
                            <span>@${user.username}</span>
                        </div>
                        <div class="leaderboard-trees">üå≥ ${user.trees_planted || 0}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadAnalytics() {
            try {
                // Get global stats
                const stats = await GreenSprintDB.analytics.getGlobalStats();
                
                // Update global impact
                document.getElementById('global-trees').textContent = (stats.totalTrees || 0).toLocaleString();
                document.getElementById('global-co2').textContent = ((stats.totalTrees || 0) * 22).toLocaleString();
                document.getElementById('global-water').textContent = ((stats.totalTrees || 0) * 400).toLocaleString();
                document.getElementById('global-oxygen').textContent = ((stats.totalTrees || 0) * 118).toLocaleString();
                document.getElementById('global-users').textContent = (stats.totalUsers || 0).toLocaleString();
                document.getElementById('global-campaigns').textContent = (stats.totalCampaigns || 0).toLocaleString();
                
                // Update analytics cards
                document.getElementById('monthly-trees').textContent = stats.monthlyTrees || 0;
                document.getElementById('active-campaigns').textContent = stats.activeCampaigns || 0;
                document.getElementById('new-users').textContent = stats.newUsersThisMonth || 0;
                
                // Get monthly trend data
                const monthlyData = await GreenSprintDB.analytics.getMonthlyTrend();
                if (monthlyData && monthlyData.length > 0) {
                    treesTimelineChart.data.labels = monthlyData.map(d => d.month);
                    treesTimelineChart.data.datasets[0].data = monthlyData.map(d => d.trees);
                    treesTimelineChart.update();
                }
                
                // Get species distribution
                const speciesData = await GreenSprintDB.analytics.getSpeciesDistribution();
                if (speciesData && speciesData.length > 0) {
                    speciesChart.data.labels = speciesData.map(s => s.name);
                    speciesChart.data.datasets[0].data = speciesData.map(s => s.count);
                    speciesChart.update();
                }
                
                // Get campaign stats
                const campaigns = await GreenSprintDB.campaigns.getAll({ status: 'active' });
                if (campaigns && campaigns.length > 0) {
                    campaignsChart.data.labels = campaigns.slice(0, 5).map(c => c.campaign_name.substring(0, 15) + '...');
                    campaignsChart.data.datasets[0].data = campaigns.slice(0, 5).map(c => c.trees_planted || 0);
                    campaignsChart.data.datasets[1].data = campaigns.slice(0, 5).map(c => c.target_trees || 0);
                    campaignsChart.update();
                }
                
                // Get top planters
                const topPlanters = await GreenSprintDB.users.getLeaderboard(10, 'monthly');
                renderTopPlanters(topPlanters);
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            GreenSprintDB.init();
            await AuthService.init();
            
            if (!AuthService.isLoggedIn()) {
                window.location.href = 'login.html?redirect=analytics.html';
                return;
            }
            
            // Update sidebar
            const profile = AuthService.getProfile();
            if (profile) {
                document.getElementById('sidebar-username').textContent = profile.full_name || profile.username;
                document.getElementById('sidebar-avatar').src = profile.avatar_url || 'assets/images/default-avatar.png';
            }
            
            // Initialize charts
            initCharts();
            
            // Load analytics data
            loadAnalytics();
        });
    </script>
</body>
</html>
